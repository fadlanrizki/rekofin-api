// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

////////////////////////////////////////////////////
// ENUM
////////////////////////////////////////////////////

enum Role {
  ADMIN
  USER
}

////////////////////////////////////////////////////
// MASTER TABLES
////////////////////////////////////////////////////

model User {
  id       Int    @id @default(autoincrement())
  fullname String
  username String
  email    String @unique
  password String
  role     Role   @default(USER)

  createdAt DateTime @default(now())

  consultations Consultation[]
  rulesCreated  Rule[]         @relation("RuleCreatedBy")

  @@map("user")
}

model Fact {
  id          Int    @id @default(autoincrement())
  code        String @unique
  description String
  question    String

  ruleConditions      RuleCondition[]
  consultationAnswers ConsultationAnswer[]

  @@map("fact")
}

model Conclusion {
  id          Int    @id @default(autoincrement())
  code        String @unique
  description String
  category    String

  ruleResults             RuleResult[]
  recommendations         Recommendation[]
  consultationConclusions ConsultationConclusion[]

  @@map("conclusion")
}

model Recommendation {
  id        Int     @id @default(autoincrement())
  text      String
  source    String?
  principle String?

  conclusionId Int
  conclusion   Conclusion @relation(fields: [conclusionId], references: [id])

  @@map("recommendation")
}

model Rule {
  id       Int     @id @default(autoincrement())
  name     String
  isActive Boolean @default(true)

  createdBy Int
  creator   User @relation("RuleCreatedBy", fields: [createdBy], references: [id])

  createdAt DateTime @default(now())

  ruleConditions RuleCondition[]
  ruleResults    RuleResult[]

  @@map("rule")
}

////////////////////////////////////////////////////
// RELATION (JUNCTION) TABLES
////////////////////////////////////////////////////

model RuleCondition {
  id Int @id @default(autoincrement())

  ruleId Int
  factId Int

  rule Rule @relation(fields: [ruleId], references: [id])
  fact Fact @relation(fields: [factId], references: [id])

  @@unique([ruleId, factId])
  @@map("rule_condition")
}

model RuleResult {
  id Int @id @default(autoincrement())

  ruleId       Int
  conclusionId Int

  rule       Rule       @relation(fields: [ruleId], references: [id])
  conclusion Conclusion @relation(fields: [conclusionId], references: [id])

  @@unique([ruleId, conclusionId])
  @@map("rule_result")
}

////////////////////////////////////////////////////
// TRANSACTION TABLES
////////////////////////////////////////////////////

model Consultation {
  id        Int                @id @default(autoincrement())
  userId    Int
  status    ConsultationStatus @default(IN_PROGRESS)
  startedAt DateTime           @default(now())
  endedAt   DateTime?

  user User @relation(fields: [userId], references: [id])

  answers     ConsultationAnswer[]
  conclusions ConsultationConclusion[]

  @@map("consultation")
}

model ConsultationAnswer {
  id             Int     @id @default(autoincrement())
  consultationId Int
  factId         Int
  value          Boolean

  consultation Consultation @relation(fields: [consultationId], references: [id])
  fact         Fact         @relation(fields: [factId], references: [id])

  @@unique([consultationId, factId])
  @@map("consultation_answer")
}

model ConsultationConclusion {
  id             Int @id @default(autoincrement())
  consultationId Int
  conclusionId   Int

  consultation Consultation @relation(fields: [consultationId], references: [id])
  conclusion   Conclusion   @relation(fields: [conclusionId], references: [id])

  @@unique([consultationId, conclusionId])
  @@map("consultation_conclusion")
}

enum ConsultationStatus {
  IN_PROGRESS
  COMPLETED
}
